在 [首次迭代](https://zhuanlan.zhihu.com/p/437867297) 中，描述用例时就基本确定了用词和句式，并未将需求分析与语言设计分开进行。鉴于 0.0.2 新添的取大文件的场景更复杂，打算在设计语法之前，先与 0.0.1 的需求一道分析。此文先回顾 0.0.1 的需求。

## 功能需求

各种输入与对应反馈：
1. 输入量之间的关联。如果关联成立，则确认；如发现未知量一并反馈。
2. 输入一个量的值。如果与原值相同，则确认；否则将该量的值修改后反馈新值。如发现与之关联的量，则一并反馈这些量的新值。
3. 输入对某量的值的询问。该量的值如存在则反馈值，否则反馈该量未知。
4. 输入某量未知。与2类似，只是值为空。

其他：
- 有输入必有反馈
  - 输入不会导致无限循环
  - 如果输入不合语法，则获取最近语义后进行相应反馈
- 反馈内容包括此次输入的影响
- 如果一次输入多句，则仅反馈最终状态

## 相关问题

部分分析结合了实现，以检查可行性。

### 关联声明在量声明之前

如果一开始在声明 `摄氏度` 之前就描述关联，按现在的实现方式，运行 `华氏度 = 摄氏度 * 9 // 5 + 32` 会报运行时错误：“摄氏度”未定义。

与其对报错信息进行转换，不如提前发现问题即反馈。此例中，在生成后端代码之前，会形成知识条目：
```json
{
  量: "华氏度",
  依赖: "摄氏度",
  算式: [<乘，9>，<除，5>，<加，32>]
}
```

可以先检查依赖的量 “摄氏度” 是否存在，相当于额外输入“摄氏度是多少”。如果不存在，则反馈“不知摄氏度是多少”，这样不需产生后端代码及运行。

完整用例如下：
```
> 华氏度是摄氏度乘9除以5加32

华氏度是摄氏度乘9除以5加32，不知摄氏度是多少

> 摄氏度是180

摄氏度是180，华氏度是356
```

### 【待验证】输入包含多句

比如同时输入上面用例的两句：
```
> 华氏度是摄氏度乘9除以5加32，摄氏度是180
```

那么反馈不应包含“不知摄氏度是多少”：
```
华氏度是摄氏度乘9除以5加32，摄氏度是180，华氏度是356
```

算法细节待定，最好早日验证可行性。

### 输入量值两种反馈

如下用例，根据量的当前值会有不同的反馈：

```
> 摄氏度是180
摄氏度是180

> 摄氏度是180
没错
```

暂未想到有何问题，但好处似乎只有让用户知道值没变这一点。

### 【待定】矛盾无法避免时的反馈

当前，输入一个量的新值后，会更新相关联的量，以保持各量的值与相关的关联不矛盾，并将为此修改的内容反馈给用户。比如之前的：
```
> 华氏度是摄氏度乘9除以5加32，摄氏度是180

华氏度是摄氏度乘9除以5加32，华氏度是356

> 摄氏度是200

摄氏度是200，华氏度是392  <----- 包括更新了的华氏度信息
```

但仍有无法避免矛盾的情况，在 [0.0.1纸上搭建一文](https://zhuanlan.zhihu.com/p/437867297) 的讨论区有过相关的讨论。比如接续上面的用例再输入：
```
> 华氏度是 400
```
根据现有关联和推导方法，仅能从摄氏度得到华氏度。如果仅将华氏度值改为400，则与现有关联存在矛盾。

这种情况下该如何反馈呢？

### 其他不合语法输入

```
华氏度是摄氏度乘除以5加32   <-- 乘除之间缺数
公斤是斤除以2a            <-- 末尾多a
```
可以加强「获取最近语义」功能来应对。比如在添加关键词后仍无法匹配语法规则时，删除某字后再尝试。
