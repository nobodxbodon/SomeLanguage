## [知乎链接](https://www.zhihu.com/question/349028712/answer/2220729987)

欢迎到 [gitee](https://gitee.com/zhishi/SomeLanguage) 或 [github](https://github.com/nobodxbodon/SomeLanguage) 库交流。

---

2021-12-01

[完成了 0.0.1 纸上原型搭建](https://zhuanlan.zhihu.com/p/439310584) 后，下面开始进行 0.0.2 迭代，纳入“找本地所有大文件”用例：

> 找本地所有大文件（及大文件夹）：电脑用的久了要找哪些地方有大垃圾。于是搜索在某目录下的超过比如 500MB 的文件（和文件夹）

此用例牵涉到文件相关功能的设计，需将长时间操作期间的即时反馈和中止纳入考虑。比如，在搜索期间，最好在找到任一符合要求的文件时即将其输出到反馈；如果发现输出太少或太多则可能需中止搜索，调整大小阈值。

另外，可调试性也很重要。比如，搜索结束如果发现没有，那么可能想要看某目录下某个或所有文件的大小、按大小排序、寻找最大文件等等。还有周边功能如将输出写到某文件。在完成搜索大文件后，最好支持搜索大文件夹。与上次搜索结果的差异等等。

考虑将格式化输出与反馈信息分开，比如今后以类似于表格形式输出所有文件及对应硬盘占用空间。这种指定格式的输出不需遵守中文自然语法。在界面中也许可以分离显示。

畅想结束。下面先放弃不必要功能，明确短期最小目标：

```
> /Documents 中大于 500 MB 的文件是哪些？

文件是“大1”，“大2”，“大3”     // 文件名称用简写，而不是全路径
```

问句句式考虑以下风格，以便于之前的“是多少”一致：
```
- (如何的)某量是多少
- (如何的)某物是哪些
```

像“/Documents 中”、“大于 500 MB” 都为定语。

## 运行时报错信息

0.0.1 中忽视了此部分。虽然对用户输入的语法问题通过寻找最近语义的方式规避，但生成代码的运行时错误尚未处理。比如：
- 数值运算
  - 除零 ZeroDivisionError: division by zero
- 文件处理
  - 文件不存在 FileNotFoundError: [Errno 2] No such file or directory: xxx

0.0.2 中应包括如何将此类信息转化为中文反馈，或添加“转述”语法应付尚无对应中文的报错，如：
```
出错信息 是 “ZeroDivisionError: division by zero”
```

---

2021-11-28

刚碰到个用例与温度转换类似：千克（kg）转换为磅（lb）。几点差异：

- 当前仅支持自然数，此例最好引入小数，因为1千克约为2.2磅
- 也许需引入“大约”的概念，尤其是在小数计算精确度有限时
- 相对于“摄氏度是100”和“100摄氏度”，“千克是10”听起来好像比“10千克”更不自然

以上用例应该会作为第三个目标用例。关于最后一项，为支持“10千克是多少磅”，是通过【获取最近语义】还是新添语法规则，仍待定。现在估计，如果照着“尽量用最近语义、少添语法规则”的思路实现，将意味着允许相当灵活但不一定总那么符合自然语言语法的用户输入。

## 获取最近语义

0.0.1 迭代发现待做事项不少，就先从这一没什么参考资料的部分开始吧。

语法规则中的“是”、“多少”、“不知”、“没错”以及四则运算都称为“关键词”。算法简述如下：

根据正则匹配进行分词，一旦发现无法匹配语法规则，即在当前位置加入逐个关键词后再看能否匹配语法规则，如仍无法匹配，则进行如 [前文](https://zhuanlan.zhihu.com/p/412465957) 演示的回退，在退到的位置再加入逐个关键词尝试，如仍无法匹配则继续回退，直到退无可退。

上述应该能和之前的无空格语法解析算法整合在一起实现。

下面纸上演算“摄氏度200”和“华氏度”两例。

### 摄氏度200

按算法演算如下：
```
匹配“摄氏度”为量，前进到位置3
匹配“200”为数值，前进到位置6
无匹配语法
在位置6添加关键词“多少”，即输入变为“摄氏度200多少”       // 尝试顺序不一定如此，仅作演示
无匹配语法
换关键词“是”、“不知”、“没错”等，都无匹配语法
回退到位置3
添加关键词“多少”，输入变为“摄氏度多少200”，前进到位置5
无匹配语法
回退到位置3
添加关键词“是”，“摄氏度是200”，前进到位置4
继续匹配“200”为数值
成功匹配到语法规则“叙述已知值”
```

### 华氏度

```
匹配“华氏度”为量，前进到位置3
无匹配语法
在位置3添加关键词“多少”，即输入变为“华氏度多少”
无匹配语法
换关键词“是”，输入变为“华氏度是”，前进到位置4
无匹配语法
添加关键词“多少”，输入变为“华氏度是多少”，前进到位置7
成功匹配到语法规则“发问未知值”
```

看起来没问题？

----

2021-11-25

接下来进行纸上原型搭建，顺便将实现相关设计比如数据结构、算法等作简要勾勒。交互过程实现的几个部分如下：

- 寻找最接近输入的语义
- （用rply定制版）对合乎语法的输入作解析，纳入知识库
- 生成python代码并执行
- 将运行结果纳入知识库
- 基于知识库的新增和改动生成中文作为反馈

成文在《[某语言概念原型 0.0.1 纸上搭建（一）](https://zhuanlan.zhihu.com/p/437867297)》

--------------

2021-11-23

## 不符语法的输入

本打算用“错误输入”为题，但似乎不大准确，因为从用户角度来看，很可能并没“错”，而仅是不合乎编译器支持的语法规则而已。从自己很可能会输入的情况开始：`摄氏度200`

两种处理方式：
1. 可识别出量和数值，可以推测两者的关系
2. 添加语法规则，支持省略“是”

第二种方式希望尽量避免，以最小化内置语法规则的数量。第一种方式如何能用一种比较通用的算法实现呢？

另外，反馈信息如果要针对不符合语法的输入进行纠正，势必需要对语法本身进行描述。这显然不能由之前的简单语法规则表达。要么通过一套特定的语法实现对自身描述，要么干脆不对语法进行纠正。

选择后者的话，如何用一种合理的方式应对貌似无数种输入呢？这里费了些思量。想象自己听到一句模糊话语时，一种处理方式是根据其中几个听清的词语“猜出”没听清的部分。类似地，在解析输入时，可以根据能够解析出的词，结合语法规则寻找最“接近”的语义作匹配。理论上无论如何都会找到至少一个语义。接下来就是如何算“接近”。猜想自然语言处理中有类似的语义分析方法，也许可以参考。

### 例一：“摄氏度 200”

具备“量”和“数值”两个词的句式有：
- 叙述已知值 : 量 "是" 数值
- 叙述关系 : 量 "是" 算式

在两词中间加上“是”就是“叙述已知值”句式。而构成“叙述关系”则还需要运算符和一个量（下称“实词”），而且这两项在原句“摄氏度 200”中都没有对应词。于是最接近的语义为“摄氏度 是 200”

### 例二：“华氏度”

具备“量”的句式有：
- 发问未知值 : 量 "是" 未知数值
- 叙述已知值 : 量 "是" 数值
- 叙述关系 : 量 "是" 算式

不需其他“实词”的只有“发问未知值”，加上 “是 多少” 即可构成，于是最接近的语义为“华氏度是多少”。

当然还有更复杂、微妙的情况，比如“200摄氏度”、“华氏度为5除摄氏度乘以9加32”，而且还有可能找到多种“接近”的语义。在初次迭代中，目标是先能支持上面这两种自己很可能用到的情况即可。

显然，如果用户输入的不合乎内置语法规则，“猜测”出的语义并不一定与用户设想的完全一致。由于反馈信息都是合乎语法的，希望的是用户可以从反馈信息回忆起或是逐渐适应内置语法规则，同时，也可以试出一些自己习惯使用、虽不符语法规则但仍能被识别的句式。

比方说，输入“华氏度为5除摄氏度乘以9加32”，假如反馈信息是“华氏度是摄氏度乘9加32”，那么用户发现少了“5除”后可能会换种输入尝试。

----

2021-11-20

之前打算先略过错误输入，即只要无法解析就反馈空信息。但思虑后打算将报错信息设计纳入初次迭代，才能确定报错信息使用编程语言同样语法这一设计思路在最基本用例中的可行性。确定语法规则后，对各种可能错误进行列举，再看是否能用相同反馈机制设计报错信息。

## 语法规则

先列出用例中所有种类语句：
```
摄氏度是180
华氏度是多少
华氏度未知 --> 不知华氏度是多少
没错
华氏度是摄氏度乘9除以5加32
```
其中“华氏度未知”比较扎眼。考虑到第二个用例中，很可能使用类似于“大于500MB的文件是哪些”的表达，“大于500MB的文件未知”听起来有些别扭，“不知大于500MB的文件是哪些”感觉自然些，而且“不知”在最前面、语义更显眼，这方面与英文报错信息“unknown variable xxx”类似。于是这里改为“不知华氏度是多少”。

下面用类似BNF表示语法规则：
```
发问未知值 : 量 "是" 未知数值
叙述已知值 : 量 "是" 数值
叙述关系 : 量 "是" 算式
算式 : 量 四则运算
四则运算 : 运算符 数值
        | 四则运算 运算符 数值
运算符 : "加" | "乘" | "减" | "除以"
未知反馈 : "不知" 发问未知值
未知数值 : "多少"
量 : "摄氏度" | "华氏度"
数值 : 【自然数】
无误 : "没错"
```

【各种可能的输入错误待续】
## 可能改进

以下不在 0.0.1 范围内，先记下：
- 改进反馈信息：有时反馈中包含了字面上与输入完全相同的内容，最好避免
- 输入矛盾信息如“摄氏度是180，华氏度是300”如何反馈
- 更多表达：
  - “已知摄氏度，如何求华氏度？”

----

2021-11-19

打算先确定一下交互环境的语境。在设计交互表达方式时遵照这一语境，尽量顺畅合理。

默认情况下，输入和反馈都是针对“当前”的信息。比如“摄氏度是180”，我虽然需要的是烤箱加热后到达的华氏温度数值，但如果仅为了换算成华氏度，对我来说语义可以简化为“当前温度是180摄氏度”。

在这一语境下，每次用户输入都会引发当前信息的变动，比如“摄氏度是180”，计算机就多了“已知摄氏度是180”这一信息。由此，本交互环境的反馈机制可以定为：计算机将每次接受输入之后引发的当前信息的变动表达出来。

下面逐句明确语义，并同时设计对应语法。

之前的“180摄氏度是多少华氏度？”，由于“180摄氏度”的表述并不直接在语法层面显式表明“180”和“摄氏度”之间的关系，于是决定改用“摄氏度是180”，并将后半句语序改为“华氏度是多少”使得语法与前半句一致，整句如下：

```
摄氏度是180，华氏度是多少
```
这里“多少”的语义为一个未知的数值。另一个搜索大文件的用例中，多半就不会用“多少”表述，而是用比如“哪些”，表示一些未知的个体。

昨天建模有个忽视的问题。按照交互环境的功能定义，仅根据“摄氏度是180，华氏度是多少”，并不能推断华氏度必须仅靠摄氏度得到，因为可能需要或可以倚靠其他内置或是上下文输入的信息（即“知识”）获得未知的华氏度数值。

那么，在用户输入“摄氏度是180，华氏度是多少”之后，根据反馈机制，在华氏度无法获得时，当前信息的变动为“摄氏度是180，华氏度未知”。这样反馈信息都为肯定句。

“华氏度是摄氏度乘9除以5加32”句法相同（..是..）无需变动。

“180摄氏度是356华氏度”如果是反馈信息，简化为“华氏度是356”，因为“摄氏度是180”是已知信息并无变动。

“没错”表达的是没有任何信息变动，继续保留。

下面是重新设计的示例会话，后面有新输入“摄氏度是200”：
```
> 摄氏度是180

摄氏度是180

> 华氏度是多少

华氏度未知

> 摄氏度是180，华氏度未知

没错

> 华氏度是摄氏度乘9除以5加32

华氏度是摄氏度乘9除以5加32。  <---- 也为新信息
华氏度是356。

> 摄氏度是180，华氏度是356

没错

> 摄氏度是200           <----- 摄氏度信息变动

摄氏度是200，华氏度是392  <----- 反馈中包括同时变了的华氏度信息
```

“摄氏度和华氏度的关系是什么？”这句暂未想到如何重新表达，但对用例来说暂不需要，先略过。另外还有输入矛盾信息如“摄氏度是180，华氏度是300”如何反馈待定。

【预告周末也许停更】

----

2021-11-18

从昨天的想象示例想到，反馈信息使用编程语言语法的一个好处是：用户可以看反馈信息“学着写”，因为反馈信息都是正确代码。

以这个摄氏转华氏的示例为目标开始第一次原型搭建迭代，编号 0.0.1。

## 交互环境功能

界面暂为传统的基于文本的交互环境：

1. 提示用户输入
2. 用户输入后以某按键（如回车）结束
3. 显示反馈信息，继续第一步

如果用户输入无法解析，包括空内容，暂时返回空反馈信息并继续提示用户输入。

当前会话中的历史内容为上下文，包括用户输入和反馈信息。
## 语言表达与建模

句式上有疑问句和肯定句两种。疑问句表达需要某个未知量。如：“180摄氏度是多少华氏度？”、“摄氏度和华氏度的关系是什么？”

肯定句表达的是已知的内容，比如：“华氏度是摄氏度乘9除以5加32”、“180摄氏度是356华氏度”、“没错”。

其中“没错”表示所有上下文的已知内容没有任何逻辑矛盾。用户输入错误内容比如“180摄氏度是300华氏度”时，会反馈错误并给出正确数值。已为此调研咨询使用定理证明辅助工具达成此部分功能。

### 内容建模

语法规则提取如果仅靠用例中初步设想的表达方式，可能有冗余。为用尽量简约的语法满足用例需要，打算先对用例中的各表述纳入某种模型，以确定语义和表达要素。

暂围绕“已知/未知”粗略建模如下：
```
180摄氏度是多少华氏度？=> 已知：180 ℃；未知：多少 ℉ 与之相等

摄氏度和华氏度的关系是什么？=> 未知：已知 ℃ 时如何得知 ℉

华氏度是摄氏度乘9除以5加32 => 已知：已知 ℃ 时如何得知 ℉

180摄氏度是356华氏度 => 已知：180 ℃ 与 356 ℉ 相等

没错 => 已知：无逻辑错误
```
发现一个之前表述上的问题：“摄氏度和华氏度的关系是什么？”并不明确。因为还有已知 ℉ 时如何得知 ℃ 这种反向关系。此处应选择更明确的表达方式。

--------------

2021-11-17

昨天在评论区探讨了些实现细节问题例如解释/编译型等。还是先描述一下设想的模样和打算吧。

比如昨天的温度转换用例，在某语言交互环境中，可能是这样（>为用户输入）：
```
> 180摄氏度是多少华氏度？

摄氏度和华氏度的关系是什么？

> 华氏度是摄氏度乘9除以5加32

180摄氏度是356华氏度
```
由于反馈信息与用户输入的语法一致，反馈信息可以作为用户输入并得到对应反馈，比如：
```
> 摄氏度和华氏度的关系是什么？

华氏度是摄氏度乘9除以5加32

> 180摄氏度是356华氏度

没错
```


在原型实现方面，由于时间紧迫，主要实现“前端”，将“后端”交由现有编程语言或是其他工具。所谓“前端”，主要是中文的解析、转换、生成上，其中“转换”会视需求转换为一个也可能多个现有编程语言的代码。比如需要简单推导的话，也许用逻辑式语言表达更简明。

作为年底前的“概念原型”目标，至少是在纸上可以手工完成上面的解析、转换（转换出的代码可运行，当然可能返回报错信息）、生成过程。当然能在代码中实现越多越好。

鉴于早期迭代可以完全在纸上进行，打算在本月尽早开始第一个迭代。视情况再决定下个月计划。

---

2021-11-16

## 工程规划

宗旨是用尽可能小的代价达成尽可能多的目标。即便不能完成所有目标，至少明确“能做到”的边界以及原因。

### 实用用例

来自个人日常生活

- 摄氏转华氏：食谱里的温度是比如 180 摄氏度，而烤箱需要设置华氏度值，需要换算。反过来换算的时候较少。
- 找本地所有大文件（及大文件夹）：电脑用的久了要找哪些地方有大垃圾。于是搜索在某目录下的超过比如 500MB 的文件（和文件夹）

可能牵涉到的功能有：
- 算术、比较
- 遍历、条件
- 量之间的关联

### 设计取舍

综合理想目标和实际情况得出的设计目标先后排序：

- 计算机反馈的信息也使用此语言：意味着交互环境的双向信息都被纳入语言设计考虑的范畴，反馈信息包括正确结果返回、提示、报错等的关键内容都需通过“某语言”表达。这是前人经验相对极少（或者说无特意关注）的方向，也是本项目的最大特色之一。
- 用户尽量不依赖编程专业概念：根据 20/80 原则，20% 的最常用功能可覆盖 80% 的最常见需求，在软件上，也许比例更加悬殊。在设计过程中，引入任何专业概念前都需推敲是否必要。比如作用域（scope）可考虑舍去，即便会导致语言功能削弱。
- 可扩展实现其他编程语言的功能：对实践和理论的要求较高，万一有余力则作些验证。

简言之，只要在年底之前能够支持两个实用用例，与上述设计目标无直接关联的其他一切语言特性都可以舍去。比如图灵完备。

接下去根据年底之前完成概念原型搭建这一目标继续落实计划，包括确定“概念原型”的含义、时间分配等

------------------------
2021-11-15（一）

下面将理想目标逐步现实化。

## 目标用户和人手

至少在概念成型之前，几乎肯定是个单人项目。鉴于 [Ruby 作者松本行弘对编程语言设计者的建议](https://zhuanlan.zhihu.com/p/93495675)：

> 自己想用就足够了

设计和功能都以自用为出发点。

昨天已阐述尽量在设计中使用自然语言语法。由于个人母语是中文，于是选用中文语法设计语言。在之后的实现中将尽量用中文命名（[实践体验比较舒适](https://zhuanlan.zhihu.com/p/261451253) ）。

鉴于人力有限，将在各阶段实现中尽可能利用现有各种编程语言生态和其他领域现有工具，以降低开发成本。

--------------------


2021-11-14

对三个目标倒序展开。

## 3 可扩展实现其他编程语言的功能

该语言的设计和实现都支持较容易地通过扩展实现其他各种编程语言的当前以及未来功能，以保证它的持续生命力。

为此需尽量避免对特殊符号相关语法的依赖，以避免同样符号在不同语言的用途有别导致在扩展时的设计难度。

## 2 计算机反馈的信息也使用此语言

用户输入和计算机反馈的两方面信息都使用同一语言，使用户有一致的体验也更利于理解反馈信息。

为此有两种可能：
- 都不使用自然语言语法
- 都使用自然语言语法

结合第三点的需求，加上可读性需要，选择尽量使用自然语言语法。

## 1 用户不需了解编程术语便可使用

现有编程语言的反馈信息和文档等都多少包含编程术语，包括数据结构如“数组”、各种语言的范式相关术语如“对象”等。与第三点类似，这些编程相关术语可以通过扩展加入。但用户不需依赖这些术语也可使用该语言并理解反馈信息，可以让用户专注于业务需求和实现思路。

这需要基于用户描述的业务特性选择合适的数据结构等实现细节，仅在少数情况如需进一步优化时让用户选择。

-------------------

2021-11-13

“某语言”的理想目标如下：

1. 用户不需了解编程术语便可使用
2. 计算机反馈的信息也使用此语言
3. 可扩展实现其他编程语言的功能

如果已有类似项目请不吝告知。

【细化目标待续】

--------------

使用中文自然语言语法是一个方向：[中文想在编程语言方面弯道超车有哪些可行的路线?](https://www.zhihu.com/question/483359591/answer/2096999846)（[库内备份](2021-08-30-中文想在编程语言方面弯道超车有哪些可行的路线?.md)）

尽量在 2021 年底之前出个概念原型，有兴趣的欢迎追更。
